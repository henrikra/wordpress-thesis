\chapter{Ohjelmointiympäristö}

\section{Ongelma}
Yleisin ongelma monen kehittäjän tiimissä on ohjelmointiympäristön erilaisuus. Tämä ilmenee siten, että joillain kehittäjilla on käyttöjärjestelmänä Linux, toisilla OS X ja lopuilla Windows. Usein projekteissa on pitkät asennusohjeet, jossa kerrotaan tarkasti mitkä ohjelmat pitää asentaa ja mitkä versiot niistä. Usein ohjelmien asennus on erilaista eri käyttöjärjestelmillä. Ei ole epätavallista, että ympäristön pystytykseen voi mennä muutama työpäivä. Usein tähän saattaa mennä henkilötyötunteina paljon sillä usein tarvitsee kysyä apua aikaisemmin projektissa olleelta henkilöltä. \cite{examplesite}

\section{Ratkaisu}
Jotta kaikille kehittäjille saadaan täysin samanlaiset kehitysympäristöt niin yksi ratkaisu on virtuaalikoneet. VirtualBox tai WMware ovat esimerkkejä virtuaalikoneohjelmista. Virtuaalikoneet ovat täysiverisiä käyttöjärjestelmiä isäntäkoneen eli käyttäjän koneen sisällä. Usein kehityskäyttöjärjestelmäksi valitaan jokin Linux paketti esim Ubuntu. Näin kaikille kehittäjille saadaan sama käyttöjärjestelmä ympäristö, jossa kehitys tapahtuu.

\section{Vagrant}
Vagrantin avulla voidaan luoda virtuaalikoneita helposti terminaalista. Vagrant on yksinkertainen ohjelma, joka vain käskyttää VirtualBoxia. Tästä syystä VirtualBox täytyy olla asennettuna, jotta Vagrant toimii.

Vagranttia kannattaa ajatella vertauskuvan kautta. Kuvitellaan, että Erik haluaa perustaa Subway-ravintolan. Koska Subway on pikaruokaravintolaketju niin on tarkasti määritelty mitä aineksia ruoka-annoksissa saa käyttää, minkälaiset työvaatteet pitää olla ja miten asiakaspalvelu tapahtuu tms. Erik saa itse valita tilan johon perustaa ravintolan. Kun tila on valittu niin seuraavaksi hänen täytyy sisustaa ravintola Subwayn määrittämällä tavalla. Seuraavaksi täytyy hankkia uuni, jääkaappi, mikro ja muut ruuan tekemiseen tarkoitetut välineet. Tässä vaiheessa voidaan huomata, että kaikki hankitut laitteet eivät välttämättä sovi valittuun liiketilaan. Esimerkiksi Erikin valitsema jääkaappi ei mahdu liiketilaan. Paljon yhteensopivuus ongelmia voi syntyä ennen kuin uusi Subway-ravintola voidaan avata. Tämä on luonnollista, koska Subwayn johto ei voi tietää miten kaikki laitteet menevät mihin tahansa liiketilaan.

Kun Subwayn liikejohto huomasi, että uusilla ravintoloiden perustajilla on usein ongelmia ravintolan pystyttämisessä ja sen saamiseksi ohjeiden mukaiseen kuntoon,  he päättivät helpottaa asiaa. He kehittivät uusien ravintoloiden perustajille paketin, josta täytyy vain painaa nappia eikä ravintoloitsijan tarvitse tehdä muuta. Erik kokeili uutta asennuspakettia ja huomasi, että paketista tuli ulos robotti, joka lähti heti rakentamaan liiketilaa ravintolalle. Robotti rakentaa aina samanlaisen tyhjän liiketilan johdon määrittelemällä tavalla. Kun liiketila on valmis niin robotti aloittaa jääkaappien, uunien ja muiden laitteiden asentamisen, jotka ovat välttämättömiä Subway-ravintolan pitäjälle. Kun laitteet ovat asennettu niin liiketila viimeistellään sisustuksella. Robotti tiesi miten asennukset ja sisustaminen piti tehdä, koska sille on määritelty ohje, jota se lukee. Kun robotti on tehnyt kaiken se antaa liiketilan avaimet Erikille, jonka ei tarvitse muuta kuin laittaa uunit päälle niin hän voi aloittaa myymisen.

\subsection{Vagrantin toiminta}
Vagrant luo isäntäkoneen sisälle virtuaalikoneen. 
Näin Vagrant toimii \ref{fig:how-vagrant-works}

\begin{figure}[h]
  \includegraphics[width=\textwidth]{how-vagrant-works}
  \caption{Vagrantin toiminta isäntäkoneen sisällä}
  \label{fig:how-vagrant-works}
\end{figure}

\subsection{Vagrantin käyttäminen}
Ennen Vagrantin käytön aloittamista täytyy VirtualBox ja Vagrant olla asennettuna. Avaamalla terminaalin voit nyt käyttää vagrant-komentoja terminaalissa. Jos komento \code{vagrant -v} palauttaa Vagrantin nykyisen version niin asennus on mennyt oikein. Tästä eteenpäin työskennellään koko ajan terminaalissa.

Siirry projektikansioon ja aja \code{vagrant init}. Vagrant luo kansioon Vagrantfile-nimisen tiedoston. Vagrantfile on käytännössä Ruby-ohjelmointi kieltä, jota Vagrant osaa lukea kun se ajetaan. Vagrantfilessä voi siis käyttää kaikkia Ruby-kielen toimintoja. Kuviosta \ref{listing:InitialVagrantfile} näkyy tiedoston sisältö ilman kommentteja.

\begin{lstlisting}[
  label=listing:InitialVagrantfile,
  language=Ruby,
  caption=Alustava Vagrantfile,
  float=h
]
Vagrant.configure(2) do |config|
  config.vm.box = "ubuntu/trusty64"
end
\end{lstlisting}

Kaikki virtuaalikoneen asetukset tulevat config-osion sisälle. Tällä hetkellä koneelle määritellään vain boxi: "ubuntu/trusty64". Mahdollisia boxeja voi etsiä osoitteesta: \url{https://atlas.hashicorp.com/boxes/search}. Boxit ovat käytännössä käyttöjärjestelmä eli pohja virtuaalikoneelle. Tässä tapauksessa boxina on Ubuntu, joka perustuu Debian Linux-jakeluun \cite{link:ubuntu}. Boxi on ravintolavertauskuvassa ravintolan liiketila. Boxi on pakko olla, mutta itsessään sillä ei tee paljon mitään. Boxi täytyy "sisustaa" eli asentaa projektiin liittyvät ohjelmat ja riippuvuudet.

Yksinkertaisin keino asentaa ohjelmia virtuaalikoneelle on shell-skriptien avulla. Jos projektiin tarvitsee asentaa vain muutama ohjelma voidaan ne asentaa laittamalla asennus-skripti suoraan Vagrantfileen. 

\begin{lstlisting}[
  label=listing:vagrant-shell-inline,
  language=Ruby,
  caption=Vagrantin yksinkertainen shell-skripti,
  float=h
]
config.vm.provision "shell",
  inline: "apt-get update; apt-get install -y apache2"
\end{lstlisting}

Kuviossa \ref{listing:vagrant-shell-inline} Vagrantfilen sisään on lisätty provisiointi shell-skripti, joka on tyyppiä inline. Tällä tarkoitetaan, että koko skripti annetaan suoraan stringinä. Tässä esimerkissä \code{apt-get update} päivittää virtuaalikoneen lokaalitpaketti linkit. \code{apt-get install -y apache2} tarkoittaa että asennetaan Apache-palvelinohjelma, jota monet käyttävät esimerkiksi PHP-projekteissa. Lippu -y pitää lisätä, koska apt varmistaan usein käyttäjältä, että haluaako hän varmasti asentaa kyseisen paketin. Lippu varmistaa sen, että kaikki pakettiin liittyviin kysymyksiin vastataan kyllä.

Skripti voidaan myös jakaa monelle riville Rubyn HEREDOC:n avulla kuvion \ref{listing:vagrant-shell-heredoc} osoittamalla tavalla. HEREDOC \cite{link:ruby-heredoc} mahdollistaa stringin kirjoittamisen monelle riville, mikä helpottaa luettavuutta kun asennetaan paljon ohjelmia.

\begin{lstlisting}[
  label=listing:vagrant-shell-heredoc,
  language=Ruby,
  caption=Vagrantin shell-skripti HEREDOC:lla,
  float=h
]
config.vm.provision "shell", inline: <<-SHELL
  apt-get update
  apt-get install -y apache2
SHELL
\end{lstlisting}

Käytännössä kuitenkin shell-skripti kannattaa laittaa erilliseen tiedostoon kuten kuviossa \ref{listing:vagrant-shell-path}. Jos Vagrantfile ja shell-skripti ovat samassa kansiossa niin riittää kun laittaa vain skriptin nimen.

Ulkoiseen skriptii täytyy laittaa alkuun kommentti, jossa kerrotaan, että kyseessä on shell-skripti. Ulkoisen skriptiin on helppo määritellä paljon eri ohjelmien asennuksia ja konfigurointeja.

\begin{lstlisting}[
  label=listing:vagrant-shell-path,
  language=Ruby,
  caption=Provisiointi-skripti voi olla myös erillisessä tiedostossa,
  float=h
]
config.vm.provision "shell", path: "install-environment.sh"
\end{lstlisting}

\begin{lstlisting}[
  label=listing:vagrant-external-shell-script,
  language=bash,
  caption=Ulkoinen shell-skripti,
  float=h
]
#!/bin/bash
apt-get update
apt-get install -y apache2
\end{lstlisting}

Koska projektin koodaaminen tehdään host-koneella niin haluamme saada yhteyden esimerkiksi Apache-palvelimeen suoraan host-koneelta. Siksi seuraavaksi pitää avata virtuaalikoneen portteja host-koneelle. Apache vastaa oletuksena osoitteesta \url{http://localhost:80}, joten haluamme avata portin 80 isäntäkoneelle. Vagrantfileen voidaan määrittää mikä virtuaalikoneen portti halutaan ohjata mihin isäntäkoneen porttiin. Kuviossa \ref{listing:vagrant-port-mapping} virtuaalikoneen portti 80 ohjataan isäntäkoneen porttiin 8080.

\begin{lstlisting}[
  label=listing:vagrant-port-mapping,
  language=Ruby,
  caption=Virtuaalikoneen portti 80 ohjataan isäntäkoneen porttiin 8080,
  float=h
]
config.vm.network "forwarded_port", guest: 80, host: 8080
\end{lstlisting}

Nyt kun isäntäkoneella mennään selaimella osoitteeseen \url{http://localhost:8080} niin pitäisi tulla näkyviin Apachen oletussivu olettaen, että Apache on asennettu joillakin edellä mainituilla tavoilla virtuaalikoneeseen. Kuvassa \ref{fig:apache-default-page} näkyy Apachen oletussivu kun virtuaalikoneen portit on ohjattu oikein.

\begin{figure}[h]
  \includegraphics[width=\textwidth]{apache-default-page}
  \caption{Isäntäkone näkee Apachen oletussivun kun oikeat portit ovat auki}
  \label{fig:apache-default-page}
\end{figure}

Kansio synkkaaminen tähän.

Vagrantin hyödyt
\begin{bullet-list}
  \item Ei tarvitse omalle (hosti)koneelle asentaa mitään.
  \item Projektin ympäristön asennustiedot ovat version hallinnassa Vagrantfilessä ja shell-skripteissä.
  \item Ympäristön saa pystyyn vain komentamalla \code{vagrant up}.
  \item Kaikilla kehittäjillä sama ympäristö.
\end{bullet-list}

Vagrantin haitat
\begin{bullet-list}
  \item Virtuaalikoneet vievät välillä enemmän keskusmuistia kuin lokaalisti ajaessa.
  \item Yleensä tarvitsee tehdä lisäsäätöä esimerkiksi ku tarkkaillaan tiedoston muutoksia.
\end{bullet-list}

\subsection{Alaluvun alaotsikko}

Otsikon jälkeen tulee tekstiä tai uusi alaotsikko.

\begin{table}[h]
  \caption{Metropolian opiskelijoiden lukuvuonna 2009–2010 suorittamat virtuaaliopinnot.}
  \begin{tabular}{| l | l | l |}
  \hline
  \bfseries Koulutusala & \bfseries Suoritusten määrä, op \\
  \hline
  Kulttuuriala & 131 \\
  \hline
  Tekniikan ja liikenteen ala & 552 \\
  \hline
  Sosiaali- ja terveysala & 175 \\
  \hline
  Liiketaloudena ala & 52 \\
  \hline
  Ei sidottu koulutusalaan & 18 \\
  \hline
  \bfseries Metropolia yhteensä & \bfseries 928 \\
  \hline
  \end{tabular}
  \label{tab:virtual studies}
\end{table}

Kuvan tai taulukon jälkeen tulee tekstiä ennen uutta kuvaa tai taulukkoa tai seuraavaa otsikkoa.

\subsection{Alaluvun alaotsikko}

Alaluvun alaotsikon jälkeen tulee tekstiä.

Sitaatti toteutetaan Lainaus-tyylillä. Sitaatin johtolauseen sisältävässä kappaleessa (välittömästi sitaattia edeltävässä kappaleessa) käytetään tyyliä ”Leipäteksti ennen lainausta”, jotta sitaatin ja johtolauseen väliin jää lyhyempi kappaleväli.

\begin{quote}
Usean rivin pituinen suora lainaus kirjoitetaan kirjainkoolla 10. Tekstissä käytetään riviväliä 1, ja teksti sisennetään. Suorassa lainauksessa käytetään mallipohjan lainaustyyliä. Lainaukseen merkitään lähdeviite.
\end{quote}

Teksti jatkuu sisennyksen jälkeen vasemmasta reunasta leipätekstityylillä.

Insinöörityöhön voidaan liittää omalla rivillään esitettyjä, numeroituja kaavoja:

\begin{equation}
  x = \frac{-b \pm \sqrt{b^{2} - 4ac}}{2a}
\end{equation}

Lisää uusi kaava valitsemalla Lisää/Pikaosat/Kaava kaavatoiminnolla. Jos haluat käyttää kaavatoiminnon sijasta vanhaa kaavaeditoria, valitse Lisää/Pikaosat/Kaava (MS Kaava 3.0 -objektina).